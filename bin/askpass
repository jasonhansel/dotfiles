#!/bin/bash

# https://gist.github.com/bailsman/0be72ceba495f4e3fab6

set -o errexit
set -o nounset
set -euo pipefail


# echo "$*" >> $HOME/test.txt
if [[ "$*" = "Enter passphrase for key"* || "$*" = "Username for"* || "$*" = "Password for"* || "$*" = *"password"*  ]]
then
 { echo "SETTITLE Saving to KWallet" ;
  echo "SETDESC [$*]" ;
  echo "GETPIN" ; } | PINENTRY="pinentry-qt" pinentry-kwallet | sed -nE 's/^D //p;s/^(D|OK)//;t;p;q1' | head -c-1
  exit 0
  if kwalletcli -f SSH -e "$*" 2>/dev/null
  then
    # echo TESTa >> $HOME/test.txt
    exit 0
  else
    # echo TESTb >> $HOME/test.txt
    PASS=$(zenity --password --title="$*" 2>/dev/null)
    kwalletcli -f SSH -e "$*" -p $PASS
    echo -n $PASS
  fi
else  
  { echo "SETTITLE Not saving" ;
  echo "SETDESC $*" ;
  echo "GETPIN" ; } | pinentry-qt | sed -n 's/^D //p' | head -c-1
  exit 0
  # echo TESTc >> $HOME/test.txt
  PASS=$(zenity --password --title="Nosave $*" 2>/dev/null)
  echo -n $PASS
  exit 0
fi

