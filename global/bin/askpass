#!/bin/bash

# https://gist.github.com/bailsman/0be72ceba495f4e3fab6

set -o errexit
set -o nounset
set -euo pipefail

exec 2>&1 &> >(tee -a $HOME/test.txt)



echo "$*" >> $HOME/test.txt
if [[ "$*" = "Enter passphrase for key"* ]]
then
  echo TESTd >> $HOME/test.txt
  { echo "SETTITLE abc" ;
  echo "SETDESC $*" ;
  echo "GETPIN" ; } | PINENTRY="pinentry-qt" pinentry-kwallet | sed -n 's/^D //p' | head -c-1
  exit 0
  if kwalletcli -f SSH -e "$*" 2>/dev/null
  then
    echo TESTa >> $HOME/test.txt
    exit 0
  else
    echo TESTb >> $HOME/test.txt
    PASS=$(zenity --password --title="$*" 2>/dev/null)
    kwalletcli -f SSH -e "$*" -p $PASS
    echo -n $PASS
  fi
else  
  { echo "SETTITLE abc" ;
  echo "SETDESC $*" ;
  echo "GETPIN" ; } | pinentry-qt | sed -n 's/^D //p' | head -c-1
  exit 0
  echo TESTc >> $HOME/test.txt
  PASS=$(zenity --password --title="Nosave $*" 2>/dev/null)
  echo -n $PASS
  exit 0
fi

